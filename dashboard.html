<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Annotator Dashboard</title>
    <!-- Bootstrap CSS Link -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div id="alertContainerDashboard" class="container mt-4"></div>
    <div class="container mt-5">
      <div class="row">
        <div class="col-6">
          <h1>Dashboard</h1>
        </div>
        <div class="col-6" style="text-align: right">
          <a class="btn btn-primary" href="create_annotation.html">
            New Annotation
          </a>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Annotator Info -->
      <div class="card">
        <div class="card-header">Annotator Information</div>
        <div class="card-body">
          <p><strong>Email:</strong> <span id="email">Loading ...</span></p>
          <p><strong>Name:</strong> <span id="name">Loading ...</span></p>
          <p>
            <strong>Date of Joining:</strong>
            <span id="joiningDate">Loading ...</span>
          </p>
          <p>
            <strong>Designation:</strong>
            <span id="designation">Loading ...</span>
          </p>
          <p><strong>Language:</strong> <span id="language">XXXX</span></p>
          <p><strong>Role:</strong> <span id="role">Loading ...</span></p>
        </div>
      </div>

      <!-- Annotations List -->
      <div class="mt-4 row">
        <div class="col-2">
          <!-- Dropdown wrapper -->
          <div class="dropdown">
            <!-- Trigger button for dropdown -->
            <button
              class="btn btn-primary dropdown-toggle"
              type="button"
              id="filterDropdownMenuButton"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Select Filter
            </button>

            <!-- Dropdown Menu -->
            <div
              class="dropdown-menu"
              aria-labelledby="filterDropdownMenuButton"
            >
              <a class="dropdown-item" href="#">Annotation ID</a>
              <a class="dropdown-item" href="#">Prompt</a>
              <a class="dropdown-item" href="#">Batch Number</a>
              <a class="dropdown-item" href="#">Annotation Date</a>
              <!-- Add more options as needed -->
            </div>
          </div>
        </div>
        <div class="col-8">
          <input
            type="text"
            class="form-control"
            placeholder="Search functionality coming soon ..."
          />
        </div>
        <div class="col-1">
          <button onclick="searchByFilter()" class="btn btn-primary">
            Search
          </button>
        </div>
        <div class="col-1">
          <button onclick="resetSearch()" class="btn btn-dark">Reset</button>
        </div>
      </div>
      <div class="card mt-4 mb-4">
        <div class="card-header">Annotations</div>
        <ul class="list-group list-group-flush" id="annotationList">
          <span class="text-center p-4">No Annotations to display here</span>
        </ul>
      </div>

      <strong style="opacity: 0.6"
        >Showing 20 records on this page, jump to the pages using the buttons
        below</strong
      >
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=1">1</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=2">2</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=3">3</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=4">4</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=5">5</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=6">6</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=7">7</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=8">8</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=9">9</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=10">10</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=11">11</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=12">12</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=1">13</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=2">14</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=3">15</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=4">16</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=5">17</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=6">18</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=7">19</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=8">20</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=9">21</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=10">22</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=11">23</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="./dashboard.html?pageNumber=12">24</a>
          </li>
          <!-- Add more page numbers as needed -->
        </ul>
      </nav>
    </div>

    <!-- Bootstrap & jQuery JS Links -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>

    <!-- Custom JS -->
    <script src="script.js"></script>

    <script>
      let annotatorDetails = {};
      if (
        localStorage.getItem("loggedIn") === undefined ||
        localStorage.getItem("annotatorEmail") === undefined ||
        localStorage.getItem("loggedIn") === null ||
        localStorage.getItem("annotatorEmail") === null
      ) {
        location.href = "/index.html";
      }

      function searchByFilter() {
        console.log("Implement search functionality");
      }

      function searchByFilter() {
        console.log("Reset annotation list");
      }

      $(document).ready(function () {
        showSuccessAlertDashboard("Loading details ...");

        $(".dropdown-menu a").click(function () {
          $("#filterDropdownMenuButton").text($(this).text());
        });

        // Create a new instance of XMLHttpRequest
        var xhr = new XMLHttpRequest();

        // Configure the request type, URL, and asynchronous flag
        xhr.open("POST", "http://localhost:3000/api/employee/filter", true);

        // Set the request header for content-type
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        // Define the callback for when the request has completed
        xhr.onload = function () {
          const response = JSON.parse(xhr.responseText);
          if (xhr.status >= 200 && xhr.status < 400) {
            // The request was successful! Handle the response here.
            document.getElementById("email").innerText =
              response.message[0]?.annotatorEmail;
            document.getElementById("name").innerText =
              response.message[0]?.annotatorName;
            document.getElementById("role").innerText =
              response.message[0]?.annotatorRole;
            document.getElementById("joiningDate").innerText = formatDate(
              response.message[0]?.dateOfJoining
            );
            document.getElementById("designation").innerText =
              response.message[0]?.designation;

            annotatorDetails = response.message[0];

            if (response.message[0].annotatorRole === "tertiary") {
              window.location.href = "./leader_dashboard.html";
            }

            localStorage.setItem(
              "annotatorRole",
              response.message[0]?.annotatorRole
            );

            // annotation request start ------------------------------
            showSuccessAlertDashboard("Loading annotations ...");
            // Create a new instance of XMLHttpRequest
            var xhrAnnotations = new XMLHttpRequest();

            const params = new Proxy(
              new URLSearchParams(window.location.search),
              {
                get: (searchParams, prop) => searchParams.get(prop),
              }
            );

            let pageNumber = params["pageNumber"];
            if (pageNumber === undefined || pageNumber === null) {
              pageNumber = 1;
            }

            // Configure the request type, URL, and asynchronous flag
            if (annotatorDetails.annotatorRole === "primary") {
              xhrAnnotations.open(
                "POST",
                `http://localhost:3000/api/annotations/filter?page=${pageNumber}`,
                true
              );
            } else {
              xhrAnnotations.open(
                "GET",
                `http://localhost:3000/api/annotations/?page=${pageNumber}`,
                true
              );
            }

            // Set the request header for content-type
            xhrAnnotations.setRequestHeader(
              "Content-Type",
              "application/json;charset=UTF-8"
            );

            // Define the callback for when the request has completed
            xhrAnnotations.onload = function () {
              const response = JSON.parse(xhrAnnotations.responseText);
              if (xhrAnnotations.status >= 200 && xhrAnnotations.status < 400) {
                // The request was successful! Handle the response here.

                const annotations = response.message;
                const annotationListContainer =
                  document.getElementById("annotationList");
                if (annotations !== undefined) {
                  annotationListContainer.innerHTML = "";
                }
                annotations?.map((annotation) => {
                  // Create the main <li> element
                  const li = document.createElement("li");
                  li.className = "list-group-item";

                  // Create the Batch # content
                  const annotationDetails = document.createElement("p");
                  annotationDetails.innerHTML = `<span class="mr-4"><strong> Annotation ID: </strong> ${
                    annotation.annotationId
                  } </span><span class="mr-4"><strong> Date: </strong> ${formatDate(
                    annotation.date
                  )} </span>  <br /> <span class="mr-4"><strong>Task Type:</strong> ${
                    annotation.taskType
                  }</span><span class="mr-4"><strong> Annotator Email: </strong> ${
                    annotation.annotatorEmail
                  } </span><br />`;

                  li.appendChild(annotationDetails);

                  const batchStrong = document.createElement("strong");
                  batchStrong.textContent = "Batch #: ";
                  li.appendChild(batchStrong);
                  li.appendChild(
                    document.createTextNode(annotation.batchNumber)
                  );

                  li.appendChild(document.createTextNode(" | "));

                  // Create the Prompt content
                  const promptStrong = document.createElement("strong");
                  promptStrong.textContent = "Prompt: ";
                  li.appendChild(promptStrong);
                  li.appendChild(
                    document.createTextNode(
                      annotation.prompt.slice(0, 200) + " ......."
                    )
                  );

                  const lineBreak = document.createElement("br");
                  li.appendChild(lineBreak);

                  // Create the open button
                  const btn = document.createElement("button");
                  btn.className = "btn btn-primary mt-2";
                  btn.textContent = "Open";
                  btn.onclick = function () {
                    openAnnotationDetails(annotation._id);
                  };
                  li.appendChild(btn);

                  if (annotatorDetails.annotatorRole !== "primary") {
                    // Create the edit button
                    const btn = document.createElement("button");
                    btn.className = "btn btn-primary ml-2 mt-2";
                    btn.textContent = "Edit";
                    btn.onclick = function () {
                      editAnnotation(annotation._id);
                    };
                    li.appendChild(btn);

                    // Create the edit button
                    const btnDelete = document.createElement("button");
                    btnDelete.className = "btn btn-danger ml-2 mt-2";
                    btnDelete.textContent = "Delete";
                    btnDelete.onclick = function () {
                      deleteAnnotation(annotation._id);
                    };
                    li.appendChild(btnDelete);
                  }

                  // append li to annotation list
                  annotationListContainer.appendChild(li);
                });
              } else {
                // The request failed with a status code outside the range [200, 400).
                // Handle the error here.
                console.error(
                  "Request failed: " +
                    xhrAnnotations.status +
                    " " +
                    xhrAnnotations.statusText
                );
                showFailAlertDashboard(response.message);
              }
            };

            // Define the callback for network errors
            xhrAnnotations.onerror = function () {
              console.error("Network error occurred.");
              showFailAlertDashboard(xhrAnnotations.message);
            };

            var dataAnnotations = JSON.stringify({
              field: "annotatorEmail",
              value: localStorage.getItem("annotatorEmail"),
            });

            if (annotatorDetails.annotatorRole === "primary") {
              xhrAnnotations.send(dataAnnotations);
            } else {
              xhrAnnotations.send();
            }

            // annotation request end --------------------------------
          } else {
            // The request failed with a status code outside the range [200, 400).
            // Handle the error here.
            console.error(
              "Request failed: " + xhr.status + " " + xhr.statusText
            );
            showFailAlertDashboard(response.message);
          }
        };

        // Define the callback for network errors
        xhr.onerror = function () {
          console.error("Network error occurred.");
          showFailAlertDashboard(xhr.message);
        };

        var data = JSON.stringify({
          field: "annotatorEmail",
          value: localStorage.getItem("annotatorEmail"),
        });
        xhr.send(data);
      });
    </script>
  </body>
</html>
